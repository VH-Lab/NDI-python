from __future__ import annotations
import ndi.types as T
from .ndi_object import NDI_Object
from uuid import uuid4
import ndi.schema.Experiment as build_experiment


class Experiment(NDI_Object):
    """
    A flatbuffer interface for experiments.

    .. currentmodule:: ndi.ndi_object

    Inherits from the :class:`NDI_Object` abstract class.
    """

    def __init__(self, name: str, daq_systems: T.List[T.DaqSystem] = [], id_: T.NdiId = None):
        """Experiment constructor: initializes with fields defined in `ndi_schema <https://>`_'s Experiment table. For use when creating a new Experiment instance from scratch.
        ::
            new_experiment = Experiment(**fields)

        .. currentmodule:: ndi.daq_system

        :param name: [description]
        :type name: str
        :param daq_systems: a list of daq_system instances, defaults to []
        :type daq_systems: List[:class:`DaqSystem`], optional
        :param id_: = defaults to None
        :type id_: str, optional
        """
        super().__init__(id_)
        self.metadata['name'] = name
        self.add_data_property('daq_systems', [])
        for daq_system in daq_systems:
            self.add_daq_system(daq_system)

    # Flatbuffer Methods
    @classmethod
    def from_flatbuffer(cls, flatbuffer: bytes) -> Experiment:
        """Alternate Experiment constructor. For use whan initializing from a flatbuffer bytearray.
        ::
            reconstructed_experiment = Experiment.from_flatbuffer(fb)

        :type flatbuffer: bytearray

        .. currentmodule:: ndi.experiment

        :rtype: :class:`Experiment`
        """
        experiment = build_experiment.Experiment.GetRootAsExperiment(
            flatbuffer, 0)
        return cls._reconstruct(experiment)

    @classmethod
    def _reconstruct(cls, experiment: T.Experiment_schema) -> Experiment:
        """Alternate Experiment constructor. For use whan initializing from a flatbuffer generated class instance.

        :param experiment: Experiment object created from class generated by `ndi_schema<https://>`_
        :type experiment: ndi.schema.Experiment.Experiment

        .. currentmodule:: ndi.experiment

        :rtype: :class:`Experiment`
        """
        return cls(
            id_=T.NdiId(experiment.Id().decode('utf8')),
            name=experiment.Name().decode('utf8')
        )

    def _build(self, builder: T.Builder) -> T.BuildOffset:
        """.. currentmodule:: ndi.ndi_object

        Called in NDI_Object.serialize() as part of flatbuffer bytearray generation from Experiment instance.

        :param builder: Builder class in flatbuffers module.
        :type builder: flatbuffers.Builder
        """
        id_ = builder.CreateString(self.id)
        name = builder.CreateString(self.name)

        build_experiment.ExperimentStart(builder)
        build_experiment.ExperimentAddId(builder, id_)
        build_experiment.ExperimentAddName(builder, name)
        return build_experiment.ExperimentEnd(builder)

    # Experiment Methods
    def update(self, name: str) -> None:
        if name:
            self.name = name
        self.ctx.update(self)

    def add_daq_system(self, daq_system: T.DaqSystem) -> None:
        """Stores a daq_system instance and labels it with the experiment's id.

        .. currentmodule:: ndi.daq_system

        :type daq_system: :class:`DaqSystem`
        """
        daq_system.experiment_id = self.id
        # NOTE: we should use daq_system_ids instead of the ndi_objects
        self.daq_systems.append(daq_system)
        self.ctx.add(daq_system)

    def add_related_obj_to_db(self, obj: T.NdiObjectWithExperimentId) -> None:
        obj.experiment_id = self.id
        self.ctx.add(obj)

    add_probe = add_related_obj_to_db
    add_channel = add_related_obj_to_db
    add_epoch = add_related_obj_to_db

    def add_related_objects_to_db(self, objects: T.Sequence[T.NdiObjectWithExperimentId]) -> None:
        for o in objects:
            o.experiment_id = self.id
        self.ctx.add(objects)

    add_probes = add_related_objects_to_db
    add_channels = add_related_objects_to_db
    add_epochs = add_related_objects_to_db

